<html>
<head><title>Checks</title></head>
<body>
  <h1>GH checks</h1>

<script>
function _insert(innerHTML) {
  let div = document.createElement("div");
  div.outerHTML = "<div><h2>" + title + "</h2>" + innerHTML + "</div>";
  document.body.appendChild(div);
}

function insert(title, id, innerHTML) {
  let div = document.createElement("section");
  div.innerHTML = "<h2>" + title + "</h2>" + innerHTML;
  document.body.appendChild(div);
}

function checkW3CJSON(repos) {
  let noJSON = [];
  repos.forEach(r => {
    if (!r.w3cJson)
      noJSON.push(r);
  });
  let s = "<p>The following repositories don't have a JSON:</p><ol>";
  noJSON = noJSON.sort((a, b) => a.name >= b.name);
  noJSON.forEach(r => { // https://github.com/w3c/perf-security-privacy/blob/gh-pages/w3c.json
    s += "<li><a href='https://github.com/" + r.nameWithOwner + "/'>" + r.nameWithOwner + '</a></li>';
  });
  s += "</ol>";
  let parsedJSON = [];
  repos.forEach(r => {
    if (r.w3cJson && !(typeof r.w3cJson === "object"))
      parsedJSON.push(r);
  });
  if (parsedJSON.length !== 0) {
    s += "<p>The following repositories don't have a parseable JSON:</p><ol>";
    parsedJSON = parsedJSON.sort((a, b) => a.name >= b.name);
    parsedJSON.forEach(r => { // https://github.com/w3c/perf-security-privacy/blob/gh-pages/w3c.json
      s += "<li><a href='https://github.com/" + r.nameWithOwner + "/blob/" + r.defaultBranch + "/w3c.json'>" + r.nameWithOwner + '</a></li>';
    });
    s += "</ol>";
  }
  let cJSON = [];
  repos.forEach(r => {
    if (r.w3cJson && !r.w3cJson.contacts)
      cJSON.push(r);
  });
  if (cJSON.length !== 0) {
    s += "<p>The following repositories don't have a contact in the JSON:</p><ol>";
    cJSON = cJSON.sort((a, b) => a.name >= b.name);
    cJSON.forEach(r => { // https://github.com/w3c/perf-security-privacy/blob/gh-pages/w3c.json
      s += "<li><a href='https://github.com/" + r.nameWithOwner + "/blob/" + r.defaultBranch + "/w3c.json'>" + r.nameWithOwner + '</a></li>';
    });
    s += "</ul>";
  }
  insert("JSON", "NoJSON", s);
  return repos;
}

function checkProtected(repos) {
  let all = [];
  repos.forEach(r => {
    if (r.w3cJson
      && (r.w3cJson["repo-type"] === "note"
         ||  r.w3cJson["repo-type"] === "rec-track")) {
      if (r.defaultBranch && r.branchProtectionRules && r.branchProtectionRules.length >= 1) {
        let found = false;
        r.branchProtectionRules.forEach(p => {
          if (p.pattern === r.defaultBranch) {
            found = true;
          }
        })
        if (!found)
          all.push(r);
      } else {
        all.push(r);
      }
    }
  });
  if (all.length > 0) {
    let s = "<p>The following repositories don't have the default branch protected:</p><ol>";
    all = all.sort((a, b) => a.name >= b.name);
    all.forEach(r => {
      s += "<li><a href='https://github.com/" + r.nameWithOwner + "/settings/branches'>" + r.nameWithOwner + '</a></li>';
    });
    s += "</ol>";
    insert("Unprotected default branch", "unprotected", s);
  }
  return repos;
}

function checkReviews(repos) {
  let all = [];
  repos.forEach(r => {
    if (r.w3cJson
      && (r.w3cJson["repo-type"] === "note"
         ||  r.w3cJson["repo-type"] === "rec-track")) {
      if (r.defaultBranch && r.branchProtectionRules && r.branchProtectionRules.length >= 1) {
        let reviews = 0;
        r.branchProtectionRules.forEach(p => {
          if (p.pattern === r.defaultBranch && p.requiredApprovingReviewCount && p.requiredApprovingReviewCount > 0) {
            reviews = r.requiredApprovingReviewCount;
          }
        })
        if (reviews === 0)
          all.push(r);
      }
    }
  });
  let s = "<p>The following repositories dont' have reviewers on the default branch:</p><ol>";
  all = all.sort((a, b) => a.name >= b.name);
  all.forEach(r => {
    s += "<li><a href='https://github.com/" + r.nameWithOwner + "/settings/branches'>" + r.nameWithOwner + '</a></li>';
  });
  s += "</ol>";
  insert("No reviews", "unreviews", s);
  return repos;
}

function checkDefaultBranch(repos) {
  checkProtected(repos);
  checkReviews(repos);
  return repos;
}

function checkErrors(repos) {
  let all = repos.filter(r => !!r.errors);
  if (all.length === 0) return repos;
  let s = "<p>The following repositories got an error:</p><ol>";
  all = all.sort((a, b) => a.name >= b.name);
  all.forEach(r => {
    s += "<li><a href='https://github.com/" + r.nameWithOwner + "/'>" + r.nameWithOwner + '</a> -- ';
    Object.keys(r.errors).forEach(k => {
      s += k + ", ";
    })
    s += '</li>';
  });
  s += "</ol>";
  insert("No reviews", "unreviews", s);
  return repos;
}

fetch("all-repos.json").then(r => r.json())
 .then(repos => { console.log("Got " + repos.length + " repositories"); return repos;})
 .then(repos => repos.filter(r => !r.isArchived))
 .then(checkDefaultBranch)
 .then(checkW3CJSON)
</script>
</body>
</html>
